<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة التسجيل</title>
    <!-- روابط Bootstrap و Font Awesome -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <!-- رابط Font Awesome 6.x for fa-solid fa-bars fa-xl (if you use it) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="./src/signup.css">
    <link rel="shortcut icon" href="https://github.com/MaisSerhan/Haven/blob/main/Assets/images/HalfTranLogo.png?raw=true">
    <style>
        /* يمكن وضع أي أنماط إضافية هنا إذا لزم الأمر */
    </style>
</head>
<body>
    <div class="container text-center">
        <a class="navbar-brand logo fs-2" href="../../index.html">
            <img src="https://github.com/MaisSerhan/Haven/blob/main/Assets/images/HalfTranLogo.png?raw=true" alt="Haven Logo" class="logo" width="50px">
            <span class="i18n-haven-title">هافن</span>
        </a>
        <h2>إنشاء حساب</h2>
        <form class="form-box" id="signupForm" enctype="multipart/form-data">
            <div class="input-box">
                <label for="name">اسم المستخدم</label>
                <input type="text" id="name" name="name" placeholder="أدخل اسم المستخدم" required>
            </div>

            <div class="input-box">
                <label for="email">البريد الإلكتروني</label>
                <input type="email" id="email" name="email" placeholder="أدخل بريدك الإلكتروني" required>
            </div>

            <div class="input-box">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" name="password" placeholder="أدخل كلمة المرور" required>
                <button type="button" class="toggle-password" onclick="togglePassword('password', this)">
                    <i class="fa fa-eye" style="color: #ff3f7e;"></i>
                </button>
            </div>

            <div class="input-box">
                <label for="confirm-password">تأكيد كلمة المرور</label>
                <input type="password" id="confirm-password" name="confirmPassword" placeholder="أكد كلمة المرور" required>
                <button type="button" class="toggle-password" onclick="togglePassword('confirm-password', this)"><i class="fa fa-eye" style="color: #ff3f7e;"></i></button>
            </div>

            <!-- اختيار النوع (أب / أم) -->
            <div class="input-box inline-flex me-5 me-sm-1 mt-2">
                <label for="role">اختر دورك</label>
                <select id="role" name="role" required>
                    <option value="">-- اختر دورك --</option>
                    <option value="mother">أم</option>
                    <option value="father">أب</option>
                </select>
            </div>

            <!-- اختيار المدينة -->
            <span class="input-box inline-flex">
                <label for="city_id">اختر مدينتك</label>
                <select id="city_id" name="city_id" required>
                    <option value="">-- اختر المدينة --</option>
                    <option value="1">رام الله والبيرة</option>
                    <option value="2">الخليل</option>
                    <option value="3">نابلس</option>
                    <option value="4">طولكرم</option>
                    <option value="5">بيت لحم</option>
                    <option value="6">جنين</option>
                    <option value="7">القدس</option>
                    <option value="8">أريحا</option>
                    <option value="9">طوباس</option>
                </select>
            </span>

            <!-- اختيار المرحلة -->
            <div class="input-box inline-flex me-5 me-sm-1 mt-2">
                <label for="level">اختر مرحلتك</label>
                <select id="level" name="level" required onchange="togglePregnancyMonths()">
                    <option value="">-- اختر مرحلتك --</option>
                    <option value="حمل">حمل</option>
                    <option value="ولادة">ولادة</option>
                    <option value="السنة الأولى من طفلك">السنة الاولى من طفلك</option>
                    <option value="السنة الثانية من طفلك">السنة الثانية من طفلك</option>
                </select>
            </div>

            <!-- حساب الحمل - يتم إخفائه/إظهاره بواسطة JavaScript -->
            <div class="input-box inline-flex me-5 me-sm-1" id="monthBox" style="display: none;">
                <label for="month">حساب الحمل</label>
                <label for="last-period-date" id="period-label">تاريخ آخر دورة شهرية</label>
                <input type="date" class="mb-3" id="last-period-date" name="last_period_date" placeholder="تاريخ آخر دورة شهرية">
                <select id="month" name="pregnancy_month"> <!-- تغيير name إلى pregnancy_month -->
                    <option value="">-- اختر الشهر الحمل--</option>
                    <option value="1">الشهر الأول</option>
                    <option value="2">الشهر الثاني</option>
                    <option value="3">الشهر الثالث</option>
                    <option value="4">الشهر الرابع</option>
                    <option value="5">الشهر الخامس</option>
                    <option value="6">الشهر السادس</option>
                    <option value="7">الشهر السابع</option>
                    <option value="8">الشهر الثامن</option>
                    <option value="9">الشهر التاسع</option>
                </select>
            </div>

            <!-- رفع صورة -->
            <div class="input-box text-center mt-2">
                <label for="profile-picture">صورتك بموقع هافن</label>
                <input type="file" class="text-center" id="profile-picture" name="file" accept="image/*">
            </div>

            <div class="mt-2">
                <button type="submit">إنشاء الحساب</button>
                <a href="./login.html">لديك حساب بالفعل؟ تسجيل الدخول</a>
            </div>
        </form>

    </div>
    <script>
        function togglePassword(id, button) {
            const input = document.getElementById(id);
            const icon = button.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function calculateAndSetPregnancyMonth() {
            const levelSelect = document.getElementById('level');
            const lastPeriodDateInput = document.getElementById('last-period-date');
            const monthSelect = document.getElementById('month');

            console.log('calculateAndSetPregnancyMonth called.'); // Debug: Function called
            console.log('levelSelect.value:', levelSelect.value); // Debug: Current level value
            console.log('lastPeriodDateInput.value:', lastPeriodDateInput.value); // Debug: Date input value

            // Reset month select
            monthSelect.value = ''; 

            if (levelSelect.value === 'حمل' && lastPeriodDateInput.value) {
                const lastPeriodDate = new Date(lastPeriodDateInput.value);
                const currentDate = new Date();

                console.log('Parsed lastPeriodDate:', lastPeriodDate); // Debug: Parsed date object
                console.log('Current Date:', currentDate); // Debug: Current date object

                // Check for invalid date
                if (isNaN(lastPeriodDate.getTime())) {
                    console.error('Invalid date input for last period.'); // Debug: Invalid date
                    return;
                }

                // Calculate difference in milliseconds
                const diffTime = currentDate.getTime() - lastPeriodDate.getTime();
                // Calculate difference in days
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Use Math.floor for whole days

                console.log('Difference in days:', diffDays); // Debug: Days difference

                let estimatedWeeks = diffDays / 7;
                let estimatedMonth = Math.floor((estimatedWeeks - 1) / 4) + 1; 
                if (estimatedMonth < 1) estimatedMonth = 1; 
                if (estimatedMonth > 9) estimatedMonth = 9; 
                
                console.log('Estimated weeks:', estimatedWeeks); // Debug: Estimated weeks
                console.log('Calculated estimatedMonth:', estimatedMonth); // Debug: Calculated month

                if (estimatedMonth >= 1 && estimatedMonth <= 9) {
                    monthSelect.value = estimatedMonth.toString();
                    console.log('Month select updated to:', monthSelect.value); // Debug: Final month value
                } else {
                    monthSelect.value = ''; // Clear if out of valid range
                    console.warn('Calculated month is out of valid range (1-9). Clearing month select.');
                }

            } else {
                console.log('Not in "حمل" stage or no date input. Clearing month select.'); // Debug: Condition not met
                monthSelect.value = '';
            }
        }

        function togglePregnancyMonths() {
            const levelSelect = document.getElementById('level');
            const monthBox = document.getElementById('monthBox');
            const lastPeriodDateInput = document.getElementById('last-period-date');
            const monthSelect = document.getElementById('month');

            if (levelSelect.value === 'حمل') {
                monthBox.style.display = 'block';
                lastPeriodDateInput.setAttribute('required', 'true');
                monthSelect.setAttribute('required', 'true');
                calculateAndSetPregnancyMonth(); // Call calculation when box is shown
            } else {
                monthBox.style.display = 'none';
                lastPeriodDateInput.removeAttribute('required');
                monthSelect.removeAttribute('required');
                lastPeriodDateInput.value = '';
                monthSelect.value = '';
            }
        }
        
        document.getElementById('role').addEventListener('change', function () {
            const role = this.value;
            const periodLabel = document.getElementById('period-label');

            if (role === 'father') {
                periodLabel.textContent = 'تاريخ آخر دورة شهرية لزوجتك';
            } else if (role === 'mother') {
                periodLabel.textContent = 'تاريخ آخر دورة شهرية لكِ';
            } else {
                periodLabel.textContent = 'تاريخ آخر دورة شهرية';
            }
            togglePregnancyMonths(); 
        });

        // Attach event listener for date input change
        document.getElementById('last-period-date').addEventListener('change', calculateAndSetPregnancyMonth);

        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            const form = e.target;
            const formData = new FormData(form);

            // Fetch last_period_date and pregnancy_month if the level is 'حمل'
            const level = document.getElementById('level').value;
            // Removed redundant formData.append calls as these fields are already collected by name attribute
            // if (level === 'حمل') {
            //     const lastPeriodDate = document.getElementById('last-period-date').value;
            //     const pregnancyMonth = document.getElementById('month').value;
            //     if (lastPeriodDate) formData.append('last_period_date', lastPeriodDate);
            //     if (pregnancyMonth) formData.append('pregnancy_month', pregnancyMonth);
            // }

            try {
                const response = await fetch("http://localhost:3001/auth/userRegister", {
                    method: "POST",
                    body: formData 
                });

                const result = await response.json();

                if (response.ok && result.token) {
                    alert("تم إنشاء الحساب بنجاح!");
                    window.location.href = "./login.html"; 
                } else if (result.errors) {
                    alert(result.errors.map(e => e.msg).join("\n"));
                } else {
                    alert("حدث خطأ أثناء التسجيل: " + (result.message || "خطأ غير معروف"));
                }
            } catch (error) {
                console.error("Error:", error);
                alert("فشل الاتصال بالخادم. يرجى التأكد من أن الخادم يعمل.");
            }
        });

        document.addEventListener('DOMContentLoaded', togglePregnancyMonths); // Call on load to set initial state
    </script>
</body>
</html>
